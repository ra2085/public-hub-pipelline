#  Copyright 2025 Google LLC
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#       http:#www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

APIProxy:
  .revision: 1
  .name: {{ slug_make ($.Values.spec | dig "info" "x-serviceName" $.Values.spec.info.title) }}
  DisplayName: {{ $.Values.spec.info.title }}
  Description: |- 
    {{ $.Values.spec.info.description | nindent 4 }}
Policies: {{ include "./policies.yaml" . | nindent 2 }}
ProxyEndpoints:
  - ProxyEndpoint:
      .name: default
      PreFlow:
        .name: PreFlow
        Request:
          - Step:
              Name: SA-ByClientIp
        #{{ if index $.Values.spec.info "x-apigee-authz-idp" }}
          - Step:
              Name: FC-AuthorizeIdPToken
        #{{end}}
        #{{ range $name, $scheme := $.Values.spec.components.securitySchemes }}
        #{{ if eq $scheme.type "apiKey" }}
          - Step:
              Name: VA-VerifyAPIKey
        #{{ end }}
        #{{ end }}
          - Step:
              Name: OAS-Validate
      Flows:
      #{{- range $path, $pathItem := $.Values.spec.paths }}
        #{{- range $verb, $opItem := $pathItem }}
          #{{- if not (regexMatch "^(post|get|put|delete|trace|options|head|patch)$" $verb) }}
            #{{- continue }}
          #{{- end }}

          #{{- if eq (include "get_visibility" $opItem) "INTERNAL" }}
              #{{- fmt_printf "Skipping internal operation '%s' (%s %s)\n" $opItem.operationId $verb $path }}
              #{{-  continue }}
          #{{-  end  }}
        - Flow:
            .name: {{ $opItem.operationId }}
            Condition: (proxy.pathsuffix MatchesPath "{{  regexReplaceAll "{[^}]*}" $path "*" }}") and (request.verb = "{{ $verb | upper }}")
            Request:
              #{{- if index $opItem "x-apigee-assign-message" }}
              #{{- range $index, $policy := index $opItem "x-apigee-assign-message" }}
              #{{- $assignTo := $policy.AssignTo | default dict }}
              #{{- $type := $assignTo.type | default "request" }}
              #{{- if eq $type "request" }}
              - Step:
                  Name: {{ $policy.name | default (printf "AM-%s-%d" $opItem.operationId $index) }}
              #{{- end }}
              #{{- end }}
              #{{- end }}
              #{{- if index $opItem "x-apigee-basic-authentication" }}
              #{{- range $index, $policy := index $opItem "x-apigee-basic-authentication" }}
              #{{- $assignTo := $policy.assignTo | default dict }}
              #{{- $type := $assignTo.type | default "request" }}
              #{{- if eq $type "request" }}
              - Step:
                  Name: {{ $policy.name | default (printf "BA-%s-%d" $opItem.operationId $index) }}
              #{{- end }}
              #{{- end }}
              #{{- end }}
            Response:
              #{{- if index $opItem "x-apigee-assign-message" }}
              #{{- range $index, $policy := index $opItem "x-apigee-assign-message" }}
              #{{- $assignTo := $policy.AssignTo | default dict }}
              #{{- $type := $assignTo.type | default "request" }}
              #{{- if eq $type "response" }}
              - Step:
                  Name: {{ $policy.name | default (printf "AM-%s-%d" $opItem.operationId $index) }}
              #{{- end }}
              #{{- end }}
              #{{- end }}
              #{{- if index $opItem "x-apigee-basic-authentication" }}
              #{{- range $index, $policy := index $opItem "x-apigee-basic-authentication" }}
              #{{- $assignTo := $policy.assignTo | default dict }}
              #{{- $type := $assignTo.type | default "request" }}
              #{{- if eq $type "response" }}
              - Step:
                  Name: {{ $policy.name | default (printf "BA-%s-%d" $opItem.operationId $index) }}
              #{{- end }}
              #{{- end }}
              #{{- end }}
        #{{- end }}
      #{{- end }}
        - Flow:
            .name: CatchAll
            Request:
              - Step:
                  Name: RF-CatchAll
      PostClientFlow:
        .name: PostClientFlow
        Description: Processed after the response is sent back to the client.
        Response:
        #{{ if index $.Values.spec.info "x-apigee-logging" }}
          Step:
            Name: FC-CloudLogging
        #{{end}}
      HTTPProxyConnection:
        BasePath: {{ include "get_basepath" (index $.Values.spec.servers 0 "url") }}
      RouteRule:
        .name: default
        TargetEndpoint: default
TargetEndpoints:
  - TargetEndpoint:
      .name: default
      HTTPTargetConnection:
        #{{- $scheme := include "get_scheme" (index $.Values.spec.servers 0 "url") }}
        #{{- if eq $scheme "https" }}
        SSLInfo:
          Enabled: true
          Enforce: true
          IgnoreValidationErrors: true
        #{{- end }}
        URL: {{ include "get_target_url" $.Values.spec.servers }}
Resources:
  - Resource:
      Type: oas
      #{{ os_writefile "./openapi.yaml" $.Values.spec_string }}
      #{{ remove_oas_extensions "./openapi.yaml" }}
      Path: ./openapi.yaml