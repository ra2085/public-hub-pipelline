#  Copyright 2024 Google LLC
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#       http:#www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

- SpikeArrest:
    .continueOnError: false
    .enabled: true
    .name: SA-ByClientIp
    DisplayName: SA-ByClientIp
    Properties: {}
    Identifier:
      .ref: client.ip
    # The example below sets the Rate value dynamically from the render context
    # You can pass the value like this --set spike_arrest_rate=300pm in the command line
    # If the value is unset, it defaults to 100pm
    Rate: {{ or (index $.Values.spec.info "x-apigee-spike-arrest-rate") "100pm" }}
#{{ if index $.Values.spec.info "x-apigee-logging" }}
- FlowCallout:
    .continueOnError: false
    .enabled: true
    .name: FC-CloudLogging
    DisplayName: FC-CloudLogging
    Properties: {}
    SharedFlowBundle: cloud-logging-v1
#{{end}}
#{{ if index $.Values.spec.info "x-apigee-authz-idp" }}
- FlowCallout:
    .continueOnError: false
    .enabled: true
    .name: FC-AuthorizeIdPToken
    DisplayName: FC-AuthorizeIdPToken
    Properties: {}
    SharedFlowBundle: authorize-idp-access-tokens
#{{end}}
- OASValidation:
    .continueOnError: false
    .enabled: true
    .name: OAS-Validate
    DisplayName: OAS-Validate
    Source: request
    OASResource: oas://openapi.yaml
#{{ range $name, $scheme := $.Values.spec.components.securitySchemes }}
#{{ if eq $scheme.type "apiKey" }}
- VerifyAPIKey:
    .continueOnError: false
    .enabled: true
    .name: VA-VerifyAPIKey
    DisplayName: VA-VerifyAPIKey
    Properties: {}
    APIKey:
      .ref: request.{{ if eq $scheme.in "query" }}queryparam{{ else }}{{ $scheme.in }}{{ end }}.{{ $scheme.name }}
#{{ end }}
#{{ end }}

#{{ range $path, $pathItem := $.Values.spec.paths }}
#{{ range $verb, $opItem := $pathItem }}
#{{ if index $opItem "x-apigee-assign-message" }}
#{{ range $index, $policy := index $opItem "x-apigee-assign-message" }}
- AssignMessage:
    .continueOnError: {{ $policy.continueOnError | default "false" }}
    .enabled: {{ $policy.enabled | default "true" }}
    .name: {{ $policy.name | default (printf "AM-%s-%d" $opItem.operationId $index) }}
    DisplayName: {{ $policy.displayName | default (printf "AM-%s-%d" $opItem.operationId $index) }}
    Properties: {}
#{{ if $policy.AssignTo }}
    AssignTo:
      .createNew: {{ $policy.AssignTo.createNew | default "false" }}
      .transport: {{ $policy.AssignTo.transport | default "http" }}
      .type: {{ $policy.AssignTo.type | default "request" }}
      #{{ if $policy.AssignTo.text }}
      text: {{ $policy.AssignTo.text }}
      #{{ end }}
#{{ end }}
#{{ if $policy.IgnoreUnresolvedVariables }}
    IgnoreUnresolvedVariables: {{ $policy.IgnoreUnresolvedVariables }}
#{{ end }}
#{{ if $policy.Set }}
    Set:
#{{ if $policy.Set.Headers }}
      Headers:
#{{ range $hIndex, $header := $policy.Set.Headers }}
        - Header:
            .name: {{ $header.name }}
            text: {{ $header.value }}
#{{ end }}
#{{ end }}
#{{ if $policy.Set.QueryParams }}
      QueryParams:
#{{ range $qIndex, $query := $policy.Set.QueryParams }}
        - QueryParam:
            .name: {{ $query.name }}
            text: {{ $query.value }}
#{{ end }}
#{{ end }}
#{{ if $policy.Set.FormParams }}
      FormParams:
#{{ range $fIndex, $form := $policy.Set.FormParams }}
        - FormParam:
            .name: {{ $form.name }}
            text: {{ $form.value }}
#{{ end }}
#{{ end }}
#{{ if $policy.Set.Payload }}
      Payload:
        .contentType: {{ $policy.Set.Payload.contentType | default "application/json" }}
        #{{ if $policy.Set.Payload.variablePrefix }}
        .variablePrefix: {{ $policy.Set.Payload.variablePrefix }}
        #{{ end }}
        #{{ if $policy.Set.Payload.variableSuffix }}
        .variableSuffix: {{ $policy.Set.Payload.variableSuffix }}
        #{{ end }}
        text: |- 
          {{ $policy.Set.Payload.value | nindent 10 }}
#{{ end }}
#{{ if $policy.Set.Verb }}
      Verb: {{ $policy.Set.Verb }}
#{{ end }}
#{{ if $policy.Set.Path }}
      Path: {{ $policy.Set.Path }}
#{{ end }}
#{{ end }}
#{{ if $policy.AssignVariable }}
#{{ range $vIndex, $variable := $policy.AssignVariable }}
    - AssignVariable:
        Name: {{ $variable.name }}
        #{{ if $variable.value }}
        Value: {{ $variable.value }}
        #{{ end }}
        #{{ if $variable.ref }}
        Ref: {{ $variable.ref }}
        #{{ end }}
#{{ end }}
#{{ end }}
#{{ end }}
#{{ end }}
#{{ if index $opItem "x-apigee-basic-authentication" }}
#{{ range $index, $policy := index $opItem "x-apigee-basic-authentication" }}
- BasicAuthentication:
    .continueOnError: {{ $policy.continueOnError | default "false" }}
    .enabled: {{ $policy.enabled | default "true" }}
    .name: {{ $policy.name | default (printf "BA-%s-%d" $opItem.operationId $index) }}
    DisplayName: {{ $policy.displayName | default (printf "BA-%s-%d" $opItem.operationId $index) }}
    Operation: {{ $policy.operation | default "Encode" }}
    IgnoreUnresolvedVariables: {{ $policy.IgnoreUnresolvedVariables | default "false" }}
#{{ if $policy.user }}
    User:
      #{{ if $policy.user.ref }}
      .ref: {{ $policy.user.ref }}
      #{{ end }}
      #{{ if $policy.user.value }}
      text: {{ $policy.user.value }}
      #{{ end }}
#{{ end }}
#{{ if $policy.password }}
    Password:
      #{{ if $policy.password.ref }}
      .ref: {{ $policy.password.ref }}
      #{{ end }}
      #{{ if $policy.password.value }}
      text: {{ $policy.password.value }}
      #{{ end }}
#{{ end }}
#{{ if $policy.assignTo }}
    AssignTo:
      .createNew: {{ $policy.assignTo.createNew | default "false" }}
      #{{ if $policy.assignTo.value }}
      text: {{ $policy.assignTo.value }}
      #{{ end }}
#{{ end }}
#{{ if $policy.source }}
    Source: {{ $policy.source }}
#{{ end }}
#{{ end }}
#{{ end }}
#{{ end }}
#{{ end }}
- RaiseFault:
    .continueOnError: false
    .enabled: true
    .name: RF-CatchAll
    DisplayName: RF-CatchAll
    FaultResponse:
      Set:
        Payload:
          .contentType: application/json
          -Data: |-
            {
               "status": 404
               "error": "NotFound"
               "message": "resource not found"
            }
        StatusCode: 404
        ReasonPhrase: Not found
    IgnoreUnresolvedVariables: true